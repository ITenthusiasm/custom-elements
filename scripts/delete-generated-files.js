import fs from "node:fs/promises";
import path from "node:path";
import url from "node:url";

/**
 * Deletes the `.d.ts` and Publish-related files that were automatically generated by the project's build step.
 *
 * @param {string} directoryPath The _absolute path_ to the source code folder _or_ a directory within that folder
 * @returns {Promise<void[]>}
 */
export default async function deleteGeneratedFilesFrom(directoryPath) {
  const filenames = await fs.readdir(directoryPath);

  return Promise.all(
    filenames.map(async (f) => {
      const filepath = path.resolve(directoryPath, f);
      if ((await fs.stat(filepath)).isDirectory()) {
        if (f === "types") return;
        return /** @type {any} */ (deleteGeneratedFilesFrom(filepath));
      }

      if (!f.endsWith(".d.ts") && f !== "LICENSE") return;
      return fs.rm(filepath);
    }),
  );
}

// Immediately clear all generated files from source code directory IF this file was invoked by the command line
if (import.meta.url === url.pathToFileURL(process.argv[1]).href) {
  const root = path.resolve(new URL(import.meta.url).pathname, "../../");
  await deleteGeneratedFilesFrom(path.resolve(root, "src"));
}
